<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tu Marka | Cat√°logo Maestro Full</title>
    <style>
        :root {
            --petroleo: #004b57;
            --purpura: #9b3081;
            --azul-claro: #007bbd;
            --fondo: #f4f7f8;
            --blanco: #ffffff;
            --verde-entrega: #4ca844;
        }

        body { font-family: 'Segoe UI', Roboto, sans-serif; margin: 0; background: var(--fondo); color: #333; padding-bottom: 120px; }

        /* BANNER */
        .aviso-top { background: var(--purpura); color: white; text-align: center; padding: 8px; font-size: 0.8rem; font-weight: bold; position: sticky; top: 0; z-index: 1001; }

        header { background: var(--blanco); padding: 1.5rem 1rem; text-align: center; border-bottom: 1px solid #eee; }
        .logo-texto { font-size: 1.6rem; font-weight: 800; color: var(--petroleo); margin: 0; text-transform: uppercase; }
        .sub-logo { font-size: 0.75rem; color: var(--azul-claro); letter-spacing: 3px; margin-bottom: 10px; }

        .contenedor { max-width: 1100px; margin: 0 auto; padding: 10px; }

        /* BUSCADOR Y CATEGOR√çAS */
        #buscador { padding: 12px 15px; width: 90%; max-width: 350px; border-radius: 25px; border: 1.5px solid #ddd; display: block; margin: 15px auto; text-align: center; outline: none; }
        .categorias-bar { display: flex; gap: 8px; overflow-x: auto; padding: 10px 0; scrollbar-width: none; }
        .categorias-bar::-webkit-scrollbar { display: none; }
        .btn-cat { background: var(--blanco); color: var(--petroleo); border: 1px solid #ddd; padding: 8px 16px; border-radius: 20px; white-space: nowrap; font-size: 0.85rem; font-weight: 600; cursor: pointer; }
        .btn-cat.activo { background: var(--purpura); color: white; border-color: var(--purpura); }

        /* GALER√çA */
        #loader { text-align: center; padding: 40px; color: var(--petroleo); font-weight: bold; }
        .galeria { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .producto { background: var(--blanco); border-radius: 12px; overflow: hidden; box-shadow: 0 3px 10px rgba(0,0,0,0.05); text-align: center; border: 1px solid #eee; position: relative; }
        .producto img { width: 100%; height: 140px; object-fit: cover; background: #f9f9f9; cursor: zoom-in; }
        
        /* BOT√ìN COMPARTIR */
        .btn-share { position: absolute; top: 8px; right: 8px; background: rgba(255,255,255,0.9); border: none; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 10; box-shadow: 0 2px 5px rgba(0,0,0,0.2); font-size: 14px; }

        .badge { position: absolute; top: 8px; left: 8px; padding: 4px 8px; border-radius: 6px; font-size: 0.65rem; font-weight: bold; color: white; z-index: 5; }
        .badge-oferta { background: var(--purpura); }
        .badge-inmediata { background: var(--verde-entrega); }

        .p-info { padding: 10px; }
        .p-nombre { font-size: 0.8rem; font-weight: bold; color: var(--petroleo); height: 32px; overflow: hidden; margin-bottom: 5px; }
        .precio { color: var(--azul-claro); font-weight: 800; font-size: 1.1rem; margin-bottom: 8px; }
        .btn-add { background: var(--azul-claro); color: white; border: none; padding: 10px; width: 100%; border-radius: 8px; font-weight: bold; cursor: pointer; }

        /* MODALES */
        .modal-general { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 5000; justify-content: center; align-items: center; }
        .modal-contenido { background: white; width: 85%; max-width: 400px; padding: 20px; border-radius: 20px; text-align: center; }
        .btn-opcion { display: block; width: 100%; padding: 15px; margin: 10px 0; border: 1.5px solid var(--azul-claro); border-radius: 10px; font-weight: bold; color: var(--azul-claro); cursor: pointer; background: white; font-size: 1rem; }
        
        #input-direccion { width: 90%; padding: 12px; margin-top: 10px; border-radius: 8px; border: 1px solid #ddd; display: none; font-size: 16px; }
        .alerta-delivery { font-size: 0.8rem; color: var(--purpura); font-weight: bold; margin: 10px 0; display: none; }

        /* CONTACTO */
        .seccion-contacto { background: var(--blanco); padding: 20px; border-radius: 15px; margin: 25px 0; text-align: center; border: 1px solid #eee; }
        .seccion-contacto h4 { color: var(--petroleo); margin: 0 0 10px 0; font-size: 0.85rem; }
        .seccion-contacto p { font-size: 0.8rem; color: #555; margin: 5px 0; }

        /* CARRITO */
        .modal-carrito { display: none; position: fixed; bottom: 85px; left: 50%; transform: translateX(-50%); width: 85%; max-width: 320px; background: white; border: 2px solid var(--petroleo); border-radius: 15px; z-index: 2005; max-height: 300px; overflow-y: auto; padding: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); }
        .item-carrito { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding: 8px 0; font-size: 0.85rem; }
        .btn-borrar { background: #ffeded; color: #ff4d4d; border: none; padding: 4px 8px; border-radius: 5px; font-weight: bold; cursor: pointer; }

        .carrito-flotante { position: fixed; bottom: 0; left: 0; right: 0; background: white; padding: 12px 20px; border-top: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; z-index: 2000; }
        .btn-wa { background: #25D366; color: white; padding: 12px 25px; border-radius: 25px; font-weight: bold; border: none; font-size: 1rem; display: none; }
    </style>
</head>
<body>

<div class="aviso-top">üöö Delivery disponible (Costo seg√∫n destino)</div>

<header>
    <div class="logo-texto">TU MARKA</div>
    <div class="sub-logo">TIENDA ONLINE</div>
</header>

<div class="contenedor">
    <input type="text" id="buscador" placeholder="üîé ¬øQu√© buscas hoy?" oninput="filtrarProductos()">
    <div class="categorias-bar" id="barra-categorias">
        <button class="btn-cat activo" onclick="seleccionarCategoria('todos', this)">Todos</button>
    </div>
    <div id="loader">Cargando cat√°logo maestro...</div>
    <div class="galeria" id="catalogo"></div>

    <div class="seccion-contacto">
        <h4>Nuestra Ubicaci√≥n</h4>
        <p id="txt-direccion">Cargando direcci√≥n...</p>
        <p>üìû Tel√©fono: <span id="txt-telefono">...</span></p>
        <a id="lnk-mapa" href="#" target="_blank" style="color:var(--azul-claro); font-size:0.8rem; font-weight:bold; text-decoration:none;">Ver en Mapa ‚Üí</a>
    </div>
</div>

<div id="modalZoom" class="modal-general" onclick="this.style.display='none'">
    <img id="imgZoomed" src="" style="max-width: 90%; max-height: 80%; border-radius: 10px;">
</div>

<div id="modalEnvio" class="modal-general">
    <div class="modal-contenido">
        <h3>üõµ ¬øC√≥mo lo recibes?</h3>
        <button class="btn-opcion" onclick="setMetodo('Retiro en Tienda')">üè¨ Retiro en Tienda</button>
        <button class="btn-opcion" onclick="mostrarDireccion()">üõµ Solicitar Delivery</button>
        <div id="area-delivery">
            <p class="alerta-delivery" id="msg-alerta">‚ö†Ô∏è El costo del env√≠o se calcula al darnos tu direcci√≥n exacta.</p>
            <input type="text" id="input-direccion" placeholder="Ej: Calle 2 con Av. 3, Casa 123...">
            <button id="btn-finalizar" class="btn-opcion" style="display:none; background:var(--verde-entrega); color:white; border:none;" onclick="enviarFinal()">‚úÖ Confirmar Pedido</button>
        </div>
        <button onclick="cerrarModalEnvio()" style="margin-top:15px; border:none; color:#888; background:none;">Cancelar</button>
    </div>
</div>

<div id="modalCarrito" class="modal-carrito">
    <h3 style="color:var(--petroleo); margin:0;">Tu Pedido</h3>
    <div id="lista-carrito"></div>
    <div id="total-carrito" style="text-align:right; margin-top:10px; font-weight:bold;"></div>
</div>

<div class="carrito-flotante">
    <div onclick="toggleCarrito()" style="cursor:pointer;">
        <strong>üõí <span id="cuenta">0</span> Items</strong>
        <small style="display:block; color:var(--azul-claro)">Ver detalle</small>
    </div>
    <button id="btnPedir" class="btn-wa" onclick="abrirModalEnvio()">Hacer Pedido</button>
</div>

<script>
    const LINK_PRODUCTOS = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTdjQeudLeSccCORPmrQSFjuC826ZE7Mm7pgxRQ99RBmfcMw9Xb6QmRETG--HavNoe_xGX2QtPtOfC7/pub?gid=0&single=true&output=csv';
    const LINK_CONFIG = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTdjQeudLeSccCORPmrQSFjuC826ZE7Mm7pgxRQ99RBmfcMw9Xb6QmRETG--HavNoe_xGX2QtPtOfC7/pub?gid=283577687&single=true&output=csv';

    let productos = [];
    let carrito = [];
    let categoriaActual = 'todos';
    let configApp = { telefono: "", direccion: "", mapa_url: "#" };
    let metodoEntrega = "";

    async function cargarTodo() {
        try {
            const resConfig = await fetch(LINK_CONFIG);
            const dataConfig = await resConfig.text();
            dataConfig.split('\n').slice(1).forEach(fila => {
                const coma = fila.indexOf(',');
                if(coma !== -1) {
                    const clave = fila.substring(0, coma).trim();
                    const valor = fila.substring(coma + 1).trim().replace(/^"|"$/g, '');
                    if(clave) configApp[clave] = valor;
                }
            });

            // AQUI SE INTEGRAN LOS DATOS DE CONTACTO
            document.getElementById('txt-direccion').innerText = configApp.direccion || "No configurada";
            document.getElementById('txt-telefono').innerText = configApp.telefono;
            document.getElementById('lnk-mapa').href = configApp.mapa_url;

            const resProd = await fetch(LINK_PRODUCTOS);
            const dataProd = await resProd.text();
            productos = dataProd.split('\n').slice(1).map(fila => {
                const col = fila.split(',');
                return {
                    id: col[0]?.trim(),
                    nombre: col[1]?.trim(),
                    precio: parseFloat(col[2]) || 0,
                    categoria: col[3]?.trim().toLowerCase(),
                    oferta: col[4]?.trim().toLowerCase() === 'si',
                    imagen: col[5]?.trim(),
                    entrega_inmediata: col[6]?.trim().toLowerCase() === 'si'
                };
            }).filter(p => p.nombre);

            generarCategorias();
            document.getElementById('loader').style.display = 'none';
            render(productos);
        } catch (e) { document.getElementById('loader').innerText = "Error de conexi√≥n."; }
    }

    function generarCategorias() {
        const barra = document.getElementById('barra-categorias');
        [...new Set(productos.map(p => p.categoria))].forEach(cat => {
            if(!cat) return;
            const btn = document.createElement('button');
            btn.className = 'btn-cat';
            btn.innerText = cat.charAt(0).toUpperCase() + cat.slice(1);
            btn.onclick = (e) => seleccionarCategoria(cat, e.target);
            barra.appendChild(btn);
        });
    }

    function seleccionarCategoria(cat, btn) {
        document.querySelectorAll('.btn-cat').forEach(b => b.classList.remove('activo'));
        btn.classList.add('activo');
        categoriaActual = cat;
        filtrarProductos();
    }

    function filtrarProductos() {
        const bus = document.getElementById('buscador').value.toLowerCase();
        render(productos.filter(p => p.nombre.toLowerCase().includes(bus) && (categoriaActual === 'todos' || p.categoria === categoriaActual)));
    }

    function render(lista) {
        const cat = document.getElementById('catalogo');
        cat.innerHTML = '';
        lista.forEach(p => {
            let bOferta = p.oferta ? `<div class="badge badge-oferta">OFERTA</div>` : '';
            let bInmed = p.entrega_inmediata ? `<div class="badge badge-inmediata" style="${p.oferta?'top:35px':''}">HOY</div>` : '';
            cat.innerHTML += `
                <div class="producto">
                    ${bOferta} ${bInmed}
                    <button class="btn-share" onclick="compartir('${p.nombre}', '${p.id}')">üîó</button>
                    <img src="${p.imagen}" onclick="window.zoomImg('${p.imagen}')" onerror="this.src='https://via.placeholder.com/150?text=Tu+Marka'">
                    <div class="p-info">
                        <div class="p-nombre">${p.nombre}</div>
                        <div class="precio">$${p.precio}</div>
                        <button class="btn-add" onclick="add('${p.id}')">A√±adir</button>
                    </div>
                </div>`;
        });
    }

    window.compartir = async (nombre, id) => {
        const shareData = { title: 'Tu Marka', text: `¬°Mira esto en Tu Marka: ${nombre}!`, url: window.location.href.split('?')[0] };
        try { if (navigator.share) { await navigator.share(shareData); } else { await navigator.clipboard.writeText(shareData.url); alert('Link copiado'); } } catch (err) {}
    };

    window.zoomImg = (url) => {
        document.getElementById('imgZoomed').src = url;
        document.getElementById('modalZoom').style.display = 'flex';
    };

    window.add = (id) => {
        const item = productos.find(p => p.id === id);
        carrito.push({...item, tempId: Date.now() + Math.random()});
        actualizar();
    };

    // FUNCION BORRAR INTEGRADA
    window.borrarItem = (tId) => {
        carrito = carrito.filter(i => i.tempId !== tId);
        actualizar();
        if(carrito.length === 0) document.getElementById('modalCarrito').style.display = 'none';
    };

    function actualizar() {
        document.getElementById('cuenta').innerText = carrito.length;
        const listaC = document.getElementById('lista-carrito');
        let total = 0;
        listaC.innerHTML = '';
        carrito.forEach(i => {
            total += i.precio;
            listaC.innerHTML += `<div class="item-carrito"><span>${i.nombre} ($${i.precio})</span><button class="btn-borrar" onclick="borrarItem(${i.tempId})">‚úï</button></div>`;
        });
        document.getElementById('total-carrito').innerText = `Total: $${total}`;
        document.getElementById('btnPedir').style.display = carrito.length > 0 ? 'block' : 'none';
    }

    function toggleCarrito() {
        const m = document.getElementById('modalCarrito');
        m.style.display = (m.style.display === 'block') ? 'none' : 'block';
    }

    function abrirModalEnvio() { document.getElementById('modalEnvio').style.display = 'flex'; }
    function cerrarModalEnvio() { document.getElementById('modalEnvio').style.display = 'none'; }

    function setMetodo(m) { metodoEntrega = m; if(m === 'Retiro en Tienda') enviarFinal(); }

    function mostrarDireccion() {
        metodoEntrega = "Delivery";
        document.getElementById('msg-alerta').style.display = 'block';
        document.getElementById('input-direccion').style.display = 'block';
        document.getElementById('btn-finalizar').style.display = 'block';
    }

    function enviarFinal() {
        let dir = document.getElementById('input-direccion').value;
        if(metodoEntrega === "Delivery" && !dir.trim()) return alert("Ingresa tu direcci√≥n");

        let total = 0;
        let lineas = carrito.map(i => { total += i.precio; return `%E2%80%A2 ${encodeURIComponent(i.nombre)} ($${i.precio})`; }).join('%0A');
        let msg = `*Tu Marka - Nuevo Pedido*%0A%0A` + lineas + `%0A%0A*TOTAL: $${total}*%0A` + `--------------------------%0A` + `üìç *M√©todo:* ${encodeURIComponent(metodoEntrega)}%0A`;
        if(metodoEntrega === "Delivery") msg += `üè† *Direcci√≥n:* ${encodeURIComponent(dir)}%0A%0A_Quedo atento al costo del env√≠o._`;

        window.open(`https://wa.me/${584129592731}?text=${msg}`, '_blank');
        cerrarModalEnvio();
    }

    cargarTodo();
</script>
</body>
</html>